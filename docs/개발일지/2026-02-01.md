# 2026-02-01

## URL 가드/리다이렉트 차단 전략 정리

### 목표
- 홈(`/`)과 현직자 검색(`/experts`), 현직자 상세(`/experts/[id]`)만 접근 허용
- 그 외 경로는 모두 홈으로 리다이렉트
- 잘못된 접근임을 홈에서 사용자에게 **경고 토스트**로 안내

### 적용한 방식
- **proxy 파일 기반 요청 가드**를 사용해 **라우트 렌더링 전에 차단**
- Next.js 16 기준: `src/proxy.ts`에 `proxy` 함수 구현
- 허용된 경로만 통과시키고, 그 외는 `/`로 리다이렉트
- 리다이렉트 시 쿼리로 **원인 플래그**(`guard=invalid`)를 부착

### 왜 proxy에서 처리?
- 클라이언트 라우팅 이후에 막는 방식보다 **빠르고 확실한 차단**
- 직접 URL 입력/새로고침/외부 링크 접근에서도 일관된 차단
- SEO 허용 경로만 통과시키는 방식이라 **인덱싱 경로 제어**가 쉬움

## 구현 상세

### 1) proxy 가드 로직
- 파일 위치: `src/proxy.ts`
- 동작 흐름:
  1. 요청 `pathname`을 검사
  2. 허용 경로면 `NextResponse.next()`로 통과
  3. 그 외는 `/`로 리다이렉트
  4. 리다이렉트 URL에 `guard=invalid` 쿼리 추가

허용한 경로:
- `/`
- `/experts`
- `/experts/*`

시스템 경로 예외:
- `/_next/*` (정적 번들/런타임)
- `/api/*` (API)
- `/favicon.ico`, `/robots.txt`, `/sitemap.xml`, `/manifest.webmanifest`

### 2) 잘못된 접근 토스트 전략

#### 전략 개요
- proxy는 서버/엣지 레이어에서 동작하므로 **토스트를 직접 띄울 수 없음**
- 따라서 **리다이렉트 시 쿼리 플래그를 전달**하고,
- 홈에서 **클라이언트 토스트**를 띄우는 방식으로 분리 처리

#### 흐름
1. proxy가 잘못된 접근 감지 → `/`로 리다이렉트하며 `?guard=invalid` 추가
2. 홈에서 `guard=invalid` 감지
3. **노란 경고 토스트**로 “잘못된 접근입니다.” 표시
4. `router.replace('/')`로 URL 정리 (쿼리 제거)

#### 토스트 구성
- 기존 토스트를 **variant 지원**하도록 확장
- `warning` 타입은 노란 배경/테두리/아이콘 컬러로 표시
- 경고 라벨은 `Warning:`로 표시

### 3) 변경 파일 목록
- `src/proxy.ts`
  - 허용 경로 통과 / 비허용 경로 리다이렉트
  - `guard=invalid` 쿼리 추가
- `src/shared/ui/toast/ToastProvider.tsx`
  - `variant: 'error' | 'warning'` 추가
  - warning 색상 테마 적용
- `src/widgets/home/ui/HomeGuardToast.tsx`
  - 홈에서 쿼리 감지 후 토스트 표시
  - 표시 후 URL 정리
- `src/widgets/home/index.ts`
  - `HomeGuardToast` export 추가
- `src/app/page.tsx`
  - 홈 루트에 `HomeGuardToast` 삽입

## 구현 의도 / 설계 이유

### 왜 쿼리 플래그 방식인가?
- proxy는 UI 레이어와 분리되어 있어 직접 토스트를 띄울 수 없음
- 리다이렉트는 서버에서 즉시 일어나고, 홈만 노출 가능하므로
- **클라이언트에서 “이전 접근이 차단되었음”을 알리기 위한 최소 정보 전달**이 필요
- 쿼리 파라미터는 가장 단순하고 안정적인 전달 방식

### 왜 홈에서 URL 정리를 하는가?
- `guard=invalid`가 남아 있으면 새로고침 시 토스트가 반복 표시됨
- 사용자 경험을 위해 1회 노출 후 URL을 깨끗하게 유지

### 왜 warning 색상으로 구분했나?
- 기존 토스트는 오류(red) 테마만 존재
- 차단 알림은 “치명적 에러”보다 **주의/경고**에 가까움
- 시각적 우선순위 조절을 위해 노란 경고 테마를 추가

## 테스트 체크리스트
- `/chat/2`, `/resume`, `/onboarding` 등 비허용 경로 접근 시 `/`로 이동
- 홈 진입 시 **노란 경고 토스트**가 한 번만 출력
- 이후 새로고침 시 경고 토스트가 재출력되지 않음
- `/`, `/experts`, `/experts/123`은 정상 접근 가능
- `/_next/*`, `/api/*` 등 시스템 경로 정상 동작

## 참고
- proxy는 **라우트 렌더링 전에 실행**되므로 접근 차단에 가장 적합
- UI 메시지는 클라이언트 영역에서만 표시 가능하므로 토스트는 홈에서 처리

---

## 추가 작업: 전역 가드 이슈로 인한 전략 변경

### 발생한 문제
1) 전역 proxy 가드로 모든 라우트를 차단하면 정적 에셋까지 차단됨  
   - `/assets/lanyard/card.glb` 요청이 HTML로 리다이렉트됨
   - GLB 로더가 HTML(`<!DOCTYPE ...>`)을 파싱하려고 하면서 런타임 오류 발생
2) “주소창 직접 입력만 차단하고 내부 클릭 이동은 허용” 요구와 충돌  
   - proxy는 요청 레벨에서 동작하므로 직접 입력/클릭을 확실히 구분하기 어려움

### 최종 전략
- 전역 proxy 가드 **폐기**
- `chat/[id]` 경로만 **서버 가드**로 전환
  - 서버에서 `getChatDetail`로 권한/존재 여부 확인
  - 실패 시 `/?guard=invalid`로 리다이렉트
  - 홈에서 경고 토스트로 “잘못된 접근입니다.” 안내

### 변경 사항
- 삭제
  - `src/proxy.ts` (전역 가드 제거)
- 추가/수정
  - `src/app/chat/[chatId]/page.tsx`
    - 서버에서 채팅 접근 검증 후 실패 시 `redirect('/?guard=invalid')`
  - `src/widgets/home/ui/HomeGuardToast.tsx`
    - 홈에서 `guard=invalid` 감지 → 노란 경고 토스트 → URL 정리
  - `src/widgets/home/index.ts`, `src/app/page.tsx`
    - 홈 토스트 컴포넌트 연결

### 결과
- 정적 리소스 로딩 문제 해결
- 주소창 직접 접근은 차단되면서 내부 이동은 정상 동작
- 사용자에게 즉시 경고 피드백 제공
