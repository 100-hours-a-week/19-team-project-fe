# 2026-01-26 개발일지

## 1) 공통 에러 응답 타입 정리

목표는 API 응답에서 내려오는 `code`를 기준으로 화면에서 통일된 토스트/리다이렉트 UX를 제공하는 것이었다. 이를 위해 **공통 에러 코드 타입**과 **공통 에러 응답 타입**을 먼저 정의했다.

- 파일: `src/shared/api/types.ts`
- 변경 내용:
  - 공통 에러 코드들을 `CommonErrorCode`로 관리
  - 공통 에러 응답 형태(`code`, `message`, `data: null`)를 `CommonErrorResponse`로 정의

추가된 공통 에러 코드 범주는 다음과 같다.
- 인증 공통: `AUTH_UNAUTHORIZED`, `AUTH_INVALID_TOKEN`
- 로그인 API 전용: `AUTH_INVALID_REQUEST`, `AUTH_INVALID_CREDENTIALS`, `AUTH_FORBIDDEN`
- 전문가 API: `EXPERT_USER_ID_INVALID`, `EXPERT_FILTER_INVALID`, `EXPERT_NOT_FOUND`
- 채팅 API: `CHAT_RECEIVER_NOT_FOUND`, `CHAT_REQUEST_TYPE_INVALID`, `CHAT_RECEIVER_IS_SELF`, `CONFLICT`, `CHAT_NOT_FOUND`
- 기타 공통: `INVALID_CURSOR`, `FORBIDDEN`, `INTERNAL_SERVER_ERROR`

이 타입은 이후 공통 핸들러에서 코드 존재 여부 확인 및 메시지 매핑에 사용된다.

---

## 2) 토스트 UI 공용 컴포넌트 추가

공통 에러 UX의 핵심은 **사용자가 어디서 에러를 만나든 동일한 방식의 토스트를 받는 것**이다. 이를 위해 전역에서 호출 가능한 토스트 컴포넌트를 만들었다.

### 2-1. ToastProvider + useToast 훅

- 파일: `src/shared/ui/toast/ToastProvider.tsx`
- 구조:
  - `ToastProvider`는 내부 상태로 `toasts` 배열을 관리
  - `pushToast(message)`를 호출하면 토스트가 추가되고 일정 시간 후 자동 제거
  - 타이머는 `useRef(Map)`로 관리하여 컴포넌트 언마운트 시 정리
  - `useToast()` 훅으로 어디서든 토스트 호출 가능

### 2-2. RootLayout에 Provider 적용

- 파일: `src/app/layout.tsx`
- 변경 내용:
  - `<ToastProvider>`로 전체 앱을 감싸 전역 토스트 사용 가능

### 2-3. 토스트 스타일

- 파일: `src/shared/ui/toast/ToastProvider.tsx`
- 현재 위치: **하단 중앙**, `bottom-12`
- 색상: 빨간색 반투명(`bg-red-600/85`)
- 모양: 둥근 캡슐(`rounded-full`)

즉, 어디서든 `pushToast('메시지')`를 호출하면 동일한 UX가 동작한다.

---

## 3) 공통 에러 처리 훅 구현

공통 에러 응답을 실제로 처리하는 **핵심 로직**을 추가했다.

- 파일: `src/shared/api/commonErrorHandler.client.ts`
- 내용:
  - `useCommonApiErrorHandler()` 훅 제공
  - 이 훅은 `handleCommonApiError(error)` 함수를 반환
  - 이 함수는 에러를 받아서 공통 에러 코드인지 판별 후 토스트/리다이렉트 수행

### 3-1. 처리 로직

1. **BusinessError**인 경우
   - `error.code`가 `CommonErrorCode`에 포함되는지 확인
   - 코드별 한글 토스트 메시지를 띄움
   - 특정 코드일 경우 `/`로 리다이렉트

2. **HttpError**인 경우
   - 상태코드를 공통 코드로 매핑
     - 401 → `AUTH_UNAUTHORIZED`
     - 403 → `FORBIDDEN`
     - 5xx → `INTERNAL_SERVER_ERROR`
   - 매핑된 메시지 토스트 출력

3. 매핑되지 않은 에러는 `false` 반환하여 기존 화면 처리로 넘김

### 3-2. 리다이렉트 규칙

- `/` 이동
  - `AUTH_UNAUTHORIZED`
  - `AUTH_INVALID_TOKEN` (리프레시 로직 없을 때)
  - `AUTH_INVALID_REQUEST`
  - `AUTH_INVALID_CREDENTIALS`
  - `AUTH_FORBIDDEN`

나머지는 **토스트만 표시**하고 화면은 유지한다.

---

## 4) 공통 에러 토스트 메시지

`COMMON_ERROR_MESSAGES`에 코드별 한글 메시지를 정의했다.

- 인증 관련
  - `AUTH_UNAUTHORIZED` → “로그인이 필요해요.”
  - `AUTH_INVALID_TOKEN` → “로그인이 만료됐어요. 다시 로그인해 주세요.”
  - `AUTH_INVALID_REQUEST` → “로그인 요청이 올바르지 않아요.”
  - `AUTH_INVALID_CREDENTIALS` → “로그인 정보가 올바르지 않아요.”
  - `AUTH_FORBIDDEN` → “접근 권한이 없어요.”

- 전문가 관련
  - `EXPERT_USER_ID_INVALID` → “요청한 현직자 정보가 올바르지 않아요.”
  - `EXPERT_FILTER_INVALID` → “필터 값이 올바르지 않아요.”
  - `EXPERT_NOT_FOUND` → “현직자 정보를 찾을 수 없어요.”

- 채팅 관련
  - `CHAT_RECEIVER_NOT_FOUND` → “요청한 현직자를 찾을 수 없어요.”
  - `CHAT_REQUEST_TYPE_INVALID` → “요청 유형이 올바르지 않아요.”
  - `CHAT_RECEIVER_IS_SELF` → “본인에게는 채팅을 요청할 수 없어요.”
  - `CONFLICT` → “이미 채팅 요청이 있어요.”
  - `CHAT_NOT_FOUND` → “채팅방을 찾을 수 없어요.”

- 기타
  - `INVALID_CURSOR` → “요청이 만료됐어요. 다시 시도해 주세요.”
  - `FORBIDDEN` → “권한이 없어요.”
  - `INTERNAL_SERVER_ERROR` → “잠시 후 다시 시도해 주세요.”

---

## 5) 공통 에러 핸들러 실제 연결

### 5-1. 온보딩 (직무/스킬/경력, 회원가입)

- 파일: `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
- 적용 위치:
  - `getJobs()`, `getSkills()`, `getCareerLevels()`의 `catch`에서 공통 에러 처리
  - `signup()` 실패 시 공통 에러 처리 우선
- 동작:
  - 공통 에러면 토스트 + 필요 시 리다이렉트
  - 공통 외 에러는 기존 에러 메시지 상태(`setSubmitError`)로 처리

### 5-2. 전문가 검색 목록

- 파일: `src/widgets/expert-search/ui/ExpertSearchPage.tsx`
- 적용 위치:
  - `getExperts()` 실패 시 공통 에러 처리
- 동작:
  - 공통 에러면 토스트 후 UI 갱신 중단
  - 공통 외 에러는 기존 네트워크 오류 메시지 사용

### 5-3. 전문가 상세

- 파일: `src/widgets/expert-detail/ui/ExpertDetailPage.tsx`
- 적용 위치:
  - `getExpertDetail()` 실패 시 공통 에러 처리
  - `createChat()` / `getChatList()` 실패 시 공통 에러 처리
- 동작:
  - 공통 에러면 토스트 (필요 시 / 이동)
  - `CHAT_ROOM_ALREADY_EXISTS`는 기존 로직 유지

### 5-4. 채팅 목록

- 파일: `src/widgets/chat-list/ui/ChatList.tsx`
- 적용 위치:
  - `getChatList()` 실패 시 공통 에러 처리
- 동작:
  - 공통 에러면 토스트 후 로딩 종료
  - 공통 외 에러는 화면 메시지로 표시

### 5-5. 채팅 메시지 목록

- 파일: `src/widgets/chat-room/ui/ChatRoom.tsx`
- 적용 위치:
  - `getChatMessages()` 실패 시 공통 에러 처리
- 동작:
  - 공통 에러면 토스트 표시
  - 공통 외 에러는 기존 `console.warn` 로깅만 수행

### 5-6. 로그인 콜백 처리

- 파일: `src/widgets/auth/ui/KakaoCallbackClient.tsx`
- 적용 위치:
  - `kakaoLogin()` 실패 시 공통 에러 처리
- 동작:
  - 공통 에러면 토스트 표시 후 종료
  - 공통 외 에러는 기존대로 `/login?error=server` 이동

---

## 6) UX 정책 요약

- **공통 에러 응답**은 화면마다 따로 처리하지 않고 `useCommonApiErrorHandler`로 통일
- 에러 메시지는 **한글 토스트**로만 노출
- 일부 인증 관련 에러는 **/로 리다이렉트**
- 공통 코드 외 비즈니스 에러는 기존 로직 유지

---

## 7) 참고 파일 목록

- 공통 타입 정의
  - `src/shared/api/types.ts`
- 공통 에러 핸들러
  - `src/shared/api/commonErrorHandler.client.ts`
- 토스트 UI
  - `src/shared/ui/toast/ToastProvider.tsx`
- 전역 Provider
  - `src/app/layout.tsx`

---

## 8) 현직자 회원가입 이메일 인증 연동 (2단계 슬라이드)

현직자 가입 시 이메일 인증 → 프로필 입력 2단계를 **슬라이드 UI로 분리**하고, 이메일 인증 API 연동 + 6자리 입력 UI/키패드를 구현했다. 인증 성공 시 자동으로 2단계로 이동한다.

### 8-1. 화면 구조 및 슬라이드 동작

- 파일: `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
- 변경 내용:
  - 현직자일 때만 `currentStep`(0/1) 기반 슬라이드 UI 구성
  - 상단에 2단계 스텝 버튼(이메일 인증/프로필 입력) 추가
  - 인증 완료 시 `currentStep` 자동 1로 전환
  - 프로필 입력 영역은 `profileFormContent`로 분리해 슬라이드에 재사용

### 8-2. 이메일 인증 UI (토스 스타일)

- 파일: `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
- 구성 요소:
  - 이메일 입력 필드 하단 라인만 노출(프라이머리 컬러)
  - 입력 옆에 전송 버튼(닉네임 전송 버튼 스타일과 동일)
  - 전송 버튼 클릭 시 6자리 입력 UI + 키패드 영역 노출
  - 키패드는 3x4 배열과 유사한 배치(숫자 + backspace + biometrics placeholder)
  - 키패드 영역은 **미리 공간 확보**(`min-h`)하여 요소 이동 방지

### 8-3. 이메일 인증 API 연동

- API
  - 전송: `POST /api/v1/email-verifications/public`
  - 검증: `PATCH /api/v1/email-verifications/public`
- 신규 파일:
  - `src/features/onboarding/api/sendEmailVerification.ts`
  - `src/features/onboarding/api/verifyEmailVerification.ts`
- 연결:
  - `src/features/onboarding/index.ts`에 export 추가
  - 전송 버튼 클릭 시 `sendEmailVerification` 호출
  - 6자리 입력 완료 시 `verifyEmailVerification` 자동 호출
  - 공통 에러 핸들러(`useCommonApiErrorHandler`)와 함께 처리

### 8-4. 인증 코드 UX 상태

- 파일: `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
- 상태:
  - 전송 상태(`isSendingVerification`, `sendVerificationMessage`, `sendVerificationError`)
  - 검증 상태(`isVerifying`, `isVerified`, `verificationError`)
  - 키패드 입력 상태(`verificationCode`)
- 동작:
  - 인증번호 6자 입력 완료 시 자동 검증 요청
  - 검증 실패 시 코드 리셋 + 헬퍼 텍스트 표시
  - 이메일이 변경되면 인증 상태 리셋

### 8-5. 만료 시간 카운트다운

- 파일: `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
- 처리:
  - 전송 응답의 `expires_at`을 기준으로 타이머 시작
  - `mm:ss` 형식으로 남은 시간 표기
  - 만료 시 에러 문구 출력 및 검증 요청 차단

### 8-6. 에러 코드 한글 매핑 + 공통 fetch 개선

- 파일: `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
  - 이메일 인증 전용 에러 코드 한글 헬퍼 텍스트 매핑:
    - `VERIFICATION_CODE_INVALID` → “인증번호 형식이 올바르지 않습니다.”
    - `VERIFICATION_CODE_MISMATCH` → “인증번호가 일치하지 않습니다.”
    - `AUTH_UNAUTHORIZED` → “인증 정보가 만료되었습니다. 다시 전송해 주세요.”
    - `VERIFICATION_CODE_EXPIRED` → “인증 시간이 만료되었습니다. 다시 전송해 주세요.”

- 파일: `src/shared/api/apiFetch.ts`
  - HTTP 4xx/5xx에서도 **응답 바디의 `code`를 읽어 `BusinessError`로 던지도록 개선**
  - 덕분에 이메일 인증에서 400/401/410 에러 코드가 매핑으로 노출됨

### 8-7. 회원가입 페이로드에 회사 이메일 연결

- 파일: `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
- 변경:
  - 현직자(`EXPERT`) 가입 시 `company_email`에 인증 이메일 입력값(`verificationEmail`) 전달
  - 기존 `email`은 소셜 로그인 응답값 유지

### 8-8. 관련 파일 목록

- 온보딩 UI
  - `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
- 이메일 인증 API
  - `src/features/onboarding/api/sendEmailVerification.ts`
  - `src/features/onboarding/api/verifyEmailVerification.ts`
  - `src/features/onboarding/index.ts`
- 공통 fetch 개선
  - `src/shared/api/apiFetch.ts`
- 적용된 화면
  - `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
  - `src/widgets/expert-search/ui/ExpertSearchPage.tsx`
  - `src/widgets/expert-detail/ui/ExpertDetailPage.tsx`
  - `src/widgets/chat-list/ui/ChatList.tsx`
  - `src/widgets/chat-room/ui/ChatRoom.tsx`
  - `src/widgets/auth/ui/KakaoCallbackClient.tsx`
