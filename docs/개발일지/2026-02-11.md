# 2026-02-11 개발일지

## 목표
- TanStack Query 기반으로 `auth/me`, `user/me` 서버 상태를 캐싱하도록 구조 통합
- 중복 호출 제거 및 `useEffect + useState` 기반 서버 상태 로직 축소
- FSD 규칙 준수: auth/user 도메인을 `entities`로 이동
- `useAuthGate` 제거 후 `useAuthStatus`로 로그인 상태 통일

---

## 변경 전 상태

### 서버 상태 호출/관리 방식
- `auth/me`는 `useAuthGate(getMe)`로 여러 feature에서 중복 호출
- `user/me`는 여러 feature에서 각각 `getUserMe()` 직접 호출
- `useEffect + useState`로 로딩/에러/데이터 상태를 직접 관리
- `useChatList`에서 1초 폴링 시 `getUserMe()`가 함께 호출되는 구조

### 구조 문제
- 동일 레이어(`features`) 간 직접 참조 발생
- 로그인 상태 로직이 분산되어 유지보수 비용 증가

---

## 변경 후 상태

### 핵심 구조
- `auth/me` → `entities/auth`로 이동
- `user/me` → `entities/user`로 이동
- TanStack Query 캐시 사용으로 동일 세션 중복 호출 방지
- 로그인 상태는 `useAuthStatus()`로 통일
- `useAuthGate` 제거

### 기대 효과
- `/bff/users/me` 중복 호출 제거
- 채팅 리스트 폴링에서 `user/me` 호출 제거
- 서버 상태 관련 `useEffect` 감소
- FSD 레이어 의존 규칙 준수 개선

---

## 작업 상세

### 1) Query Provider 추가
- 전역 QueryClient 공급
- `src/app/layout.tsx`에서 적용

추가 파일:
- `src/shared/lib/react-query/QueryProvider.tsx`
- `src/shared/lib/react-query/index.ts`

---

### 2) auth/user Query 훅 생성 (entities)

#### auth
- `src/entities/auth/api/getAuthStatus.client.ts`
- `src/entities/auth/model/useAuthStatus.client.ts`
  - `queryKey: ['auth','me']`
  - `staleTime: 10_000`
  - `retry: false`

#### user
- `src/entities/user/api/getUserMe.ts`
- `src/entities/user/model/useUserMeQuery.client.ts`
  - `queryKey: ['user','me']`
  - `staleTime: 30_000`
  - `enabled` 옵션 지원

#### re-export 정리
- `src/features/auth/api/getMe.client.ts` → `entities/auth` 재export
- `src/features/me/api/getUserMe.ts` → `entities/user` 재export

---

### 3) 사용처 전환 및 useAuthGate 제거

#### useAuthGate 제거
- `src/features/auth/model/useAuthGate.client.ts` 삭제
- `src/features/auth/index.ts` export 제거

#### 사용처 교체
- `src/features/me/model/useMyPage.client.ts`
  - `getUserMe + useEffect` 제거
  - `useUserMeQuery`로 대체
  - `authStatus`는 `useAuthStatus` 사용

- `src/features/me/model/useMyPageEditLoader.client.ts`
  - `getUserMe()` 호출 제거
  - `useUserMeQuery` 데이터로 초기 값 주입

- `src/features/chat/model/useChatList.client.ts`
  - 1초 폴링에서 `getUserMe()` 제거
  - `currentUser`는 Query 캐시에서만 조회

- `src/features/chat/model/useChatCurrentUser.client.ts`
  - 기존 `getUserMe + refreshAuthTokens` 제거
  - `useUserMeQuery` 기반으로 단순화

- `src/features/resume/model/useResumeList.client.ts`
- `src/features/resume/model/useResumeDetail.client.ts`
- `src/features/resume/model/useResumeEdit.client.ts`
  - `useAuthStatus`로 교체

- `src/widgets/expert/ui/ExpertDetailPage.tsx`
  - `useAuthStatus`로 교체

- `src/features/expert/model/useChatRequest.client.ts`
  - `getAuthStatus()` 사용

---

## 커밋 분할

1. `feat: TanStack Query Provider 추가`
   - 전역 Query Provider 추가 및 layout 적용

2. `feat: auth/user 쿼리 훅 추가`
   - `entities/auth`, `entities/user`에 API + Query 훅 추가
   - 기존 `getMe`, `getUserMe`는 re-export

3. `feat: 로그인 상태 Query 전환 및 useAuthGate 제거`
   - `useAuthGate` 삭제
   - 주요 사용처 `useAuthStatus`로 교체
   - `user/me` 중복 호출 제거

---

## 변경 파일 요약

### 신규
- `src/shared/lib/react-query/QueryProvider.tsx`
- `src/shared/lib/react-query/index.ts`
- `src/entities/auth/api/getAuthStatus.client.ts`
- `src/entities/auth/model/useAuthStatus.client.ts`
- `src/entities/user/api/getUserMe.ts`
- `src/entities/user/model/useUserMeQuery.client.ts`
- `src/entities/user/index.ts`

### 수정
- `src/app/layout.tsx`
- `src/entities/auth/index.ts`
- `src/features/auth/api/getMe.client.ts`
- `src/features/me/api/getUserMe.ts`
- `src/features/me/model/useMyPage.client.ts`
- `src/features/me/model/useMyPageEdit.client.ts`
- `src/features/me/model/useMyPageEditLoader.client.ts`
- `src/features/me/model/useMyPageVerify.client.ts`
- `src/features/chat/model/useChatList.client.ts`
- `src/features/chat/model/useChatCurrentUser.client.ts`
- `src/features/resume/model/useResumeList.client.ts`
- `src/features/resume/model/useResumeDetail.client.ts`
- `src/features/resume/model/useResumeEdit.client.ts`
- `src/widgets/expert/ui/ExpertDetailPage.tsx`
- `src/features/expert/model/useChatRequest.client.ts`

### 삭제
- `src/features/auth/model/useAuthGate.client.ts`

---

## 테스트/검증 메모

- `pnpm format` 및 `pnpm lint`는 커밋 시 자동 실행됨
- 기능 테스트는 아직 미실행 (필요 시 다음 단계에서 수행)

---

## 다음 단계 제안

- 실제 네트워크 요청 수 비교 측정 (chat list 5분 유지, `/bff/users/me` 호출 수 확인)
- `user/me` 변경 작업 후 `invalidateQueries(['user','me'])` 적용 여부 검토
- 추가적으로 `resume`, `expert` 도메인 서버 상태도 Query로 확장 여부 결정
