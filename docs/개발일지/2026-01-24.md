# 개발일지 - 2026-01-24

## 작업 요약
- BFF 기반 인증 흐름 정리: 로그인/회원가입/인증 확인(/api/auth/me) 라우트와 서버 Use Case 도입.
- 채팅 API를 BFF로 이식하여 클라이언트 토큰 접근 제거.
- 채팅 진입 시 인증 확인 후 바텀시트로 로그인 유도.
- cookies() 동작 혼선/캐시/Promise 직렬화 등으로 발생한 오류를 정리하고 해결.

## 구현 상세

### 1) 로그인 BFF 라우트 정리
- 목적: 클라이언트가 토큰을 직접 다루지 않도록 하고, 서버에서 HttpOnly 쿠키로 저장.
- 흐름
  1) Client -> `POST /api/auth/kakao/login` (code 전달)
  2) Next.js BFF -> 백엔드 카카오 로그인 호출
  3) BFF가 `access_token`, `refresh_token`을 HttpOnly 쿠키로 설정
  4) Client에는 토큰이 아닌 최소 정보만 반환
- 핵심 파일
  - `src/app/api/auth/kakao/login/route.ts`
    - `kakaoLogin` 결과의 access/refresh token을 `response.cookies.set`로 저장
  - `src/features/auth/server/kakaoLogin.server.ts`
    - 백엔드 응답에서 토큰/유저정보 분리

### 2) 회원가입 BFF 이식
- 목적: 회원가입도 로그인과 동일하게 서버에서만 토큰 처리.
- 흐름
  1) Client -> `POST /api/auth/signup`
  2) Next.js BFF -> 백엔드 `/api/v1/auth/signup`
  3) BFF가 `access_token`, `refresh_token` HttpOnly 쿠키 저장
  4) Client에는 성공 여부만 반환
- 핵심 파일
  - `src/app/api/auth/signup/route.ts`
    - `signup` 결과 응답 래핑(ApiResponse)
  - `src/features/auth/server/signup.server.ts`
    - 백엔드 회원가입 호출 + 쿠키 저장
  - `src/shared/api/server/authApi.server.ts`
    - 서버 전용 signup API 함수 추가
  - `src/features/onboarding/api/signup.ts`
    - 백엔드 직통 호출 제거, `/api/auth/signup` 사용
  - `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`
    - `document.cookie`로 토큰 저장하던 로직 제거

### 3) /api/auth/me 추가 (인증 상태 확인 BFF)
- 목적: 클라이언트는 인증 판단을 단일 API(`/api/auth/me`)로 일원화.
- 흐름
  1) Client -> `GET /api/auth/me`
  2) BFF에서 `cookies()`로 `access_token` 존재 여부 판단
  3) `{ authenticated: boolean }` 반환
- 핵심 파일
  - `src/app/api/auth/me/route.ts`
    - `dynamic = 'force-dynamic'`
    - `Cache-Control: no-store` 헤더 추가
  - `src/features/auth/server/getMe.server.ts`
    - `await cookies()`로 access_token 확인
  - `src/features/auth/api/getMe.client.ts`
    - `fetch('/api/auth/me', { cache: 'no-store', credentials: 'include' })`

### 4) 채팅 API BFF 이식
- 목적: 클라이언트에서 access_token을 읽지 않도록 전환.
- 이식 범위
  1) `getChatList`
  2) `getChatMessages`
- 흐름
  1) Client -> `/api/chat` 또는 `/api/chat/:chatId/messages`
  2) BFF에서 `cookies()`로 access_token 읽고 Authorization 헤더 생성
  3) 백엔드 `/api/v1/chats` 호출 후 응답 래핑
- 핵심 파일
  - `src/app/api/chat/route.ts`
    - 리스트 BFF 라우트
  - `src/app/api/chat/[chatId]/messages/route.ts`
    - 메시지 목록 BFF 라우트
  - `src/features/chat/server/getChatList.server.ts`
  - `src/features/chat/server/getChatMessages.server.ts`
  - `src/features/chat/api/getChatList.ts`
  - `src/features/chat/api/getChatMessages.ts`

### 5) 채팅 진입 시 인증 가드 + 바텀시트
- 목적: 비로그인 사용자에게 채팅 UI 대신 로그인 유도.
- 흐름
  1) `/chat` 진입 시 `getMe()` 호출
  2) `authenticated=false`이면 바텀시트 표시
  3) 바텀시트 닫기 → 홈(`/`)으로 이동
- 핵심 파일
  - `src/widgets/chat-list/ui/ChatList.tsx`
    - `getMe()` 호출, 상태 분기
    - `BottomSheet`에 `KakaoLoginButton` 렌더

## 트러블슈팅 (cookies() 지옥)

### 이슈 A) `cookies().get is not a function` / `cookies() returns a Promise...`
- 증상
  - `cookieStore.get is not a function`
  - `cookies() returns a Promise and must be unwrapped...`
- 원인
  - App Router의 Dynamic API가 런타임에서 비동기 동작.
  - 타입 정의/빌드 컨텍스트에 따라 `cookies()`가 Promise처럼 동작.
- 해결
  - Route Handler / 서버 Use Case에서 `await cookies()` 사용.
  - `getMe` 내부에서 `await`로 접근하도록 통일.

### 이슈 B) `/api/auth/me` 응답이 `{}`로 내려옴
- 증상
  - 네트워크에서 200 OK인데 Body가 `{}`.
- 원인
  - route handler가 async가 아니어서 `Promise`를 그대로 `NextResponse.json`에 전달.
- 해결
  - `export async function GET()`로 변경 후 `await getMe()`.

### 이슈 C) 쿠키가 있는데도 `authenticated: false`
- 증상
  - Network 탭에 `access_token`이 요청 쿠키에 포함돼 있는데 응답이 false.
- 원인
  - `cookies()`를 비동기 컨텍스트에서 잘못 읽는 상황.
  - 과거 client `document.cookie`로 남은 토큰 흔적이 충돌 가능.
- 해결
  - `await cookies()` 방식으로 고정.
  - 클라이언트에서 토큰 저장 로직 제거.
  - `/api/auth/me` 캐시 방지(`force-dynamic`, `no-store`).

### 이슈 D) Radix Dialog 경고
- 증상
  - `DialogContent requires a DialogTitle...`
- 원인
  - `BottomSheet`에 `title` 없이 렌더링.
- 해결
  - 바텀시트에 `title` 전달.

## 파일/폴더 변경 요약
- 인증 BFF
  - `src/app/api/auth/kakao/login/route.ts`
  - `src/app/api/auth/signup/route.ts`
  - `src/app/api/auth/me/route.ts`
  - `src/features/auth/server/kakaoLogin.server.ts`
  - `src/features/auth/server/signup.server.ts`
  - `src/features/auth/server/getMe.server.ts`
  - `src/features/auth/api/getMe.client.ts`
  - `src/shared/api/server/authApi.server.ts`
- 채팅 BFF
  - `src/app/api/chat/route.ts`
  - `src/app/api/chat/[chatId]/messages/route.ts`
  - `src/features/chat/server/getChatList.server.ts`
  - `src/features/chat/server/getChatMessages.server.ts`
  - `src/features/chat/api/getChatList.ts`
  - `src/features/chat/api/getChatMessages.ts`
- UI/가드
  - `src/widgets/chat-list/ui/ChatList.tsx`
  - `src/widgets/onboarding/ui/OnboardingProfileForm.tsx`

## 결과 요약
- 클라이언트에서 토큰 접근 로직 제거.
- 인증 판단 기준을 `/api/auth/me` 단일 API로 통일.
- 채팅 API를 BFF로 이식해 access_token을 서버에서만 처리.
- cookies() 사용법을 `await` 기준으로 정리해 런타임 오류 해결.

## 다음 작업 메모
- `/api/auth/me` 토큰 존재 체크를 백엔드 검증으로 확장(토큰 유효성 확인).
- refresh 로직 도입 시 `/api/auth/refresh` or 미들웨어 설계 필요.
