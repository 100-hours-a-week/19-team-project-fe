name: Re-Fit Frontend CD

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI workflow run ID (ÏûêÎèô ÏûÖÎ†• ÎòêÎäî ÏßÅÏ†ë ÏûÖÎ†•)'
        required: false
        type: string
      sha:
        description: 'Commit SHA (ÏûêÎèô ÏûÖÎ†• ÎòêÎäî ÏßÅÏ†ë ÏûÖÎ†•)'
        required: false
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: choice
        default: 'develop'
        options:
          - develop
          - main
      version_tag:
        description: 'Version tag (e.g., v1.0.0, develop-abc1234)'
        required: false
        type: string
      artifact_prefix:
        description: 'Artifact prefix (e.g., v1.0.0-abc1234, develop-abc1234)'
        required: false
        type: string
      use_latest_artifact:
        description: 'run_id/shaÎ•º ÏûÖÎ†•ÌïòÏßÄ ÏïäÏúºÎ©¥ ÏÑ†ÌÉùÌïú Î∏åÎûúÏπòÏùò ÏµúÏã† ÏïÑÌã∞Ìå©Ìä∏ ÏÇ¨Ïö©'
        required: true
        type: boolean
        default: true

env:
  NODE_VERSION: 22
  PNPM_VERSION: 10

jobs:
  deploy:
    # Release job ÏÑ±Í≥µ ÌõÑ Ìä∏Î¶¨Í±∞Îêú Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ
    runs-on: ubuntu-latest
    environment: ${{ inputs.branch == 'main' && 'production' || 'development' }}
    steps:
      - name: Find Latest Artifact (if needed)
        if: inputs.use_latest_artifact == true && (inputs.run_id == '' || inputs.sha == '' || inputs.artifact_prefix == '')
        id: find-artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const branch = '${{ inputs.branch }}';
            console.log(`üîç Finding latest artifact for branch: ${branch}`);

            // CI ÏõåÌÅ¨ÌîåÎ°úÏö∞Ïùò ÏµúÍ∑º ÏÑ±Í≥µÌïú Ïã§Ìñâ Ï∞æÍ∏∞
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: branch,
              status: 'success',
              per_page: 10
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`‚ùå No successful CI runs found for branch: ${branch}`);
              return;
            }

            // ÏïÑÌã∞Ìå©Ìä∏Í∞Ä ÏûàÎäî ÏµúÏã† Ïã§Ìñâ Ï∞æÍ∏∞
            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });

              const buildArtifact = artifacts.data.artifacts.find(
                a => a.name.startsWith('frontend-build-')
              );

              if (buildArtifact) {
                const sha = run.head_sha;
                const sha_short = sha.substring(0, 7);

                // ÏïÑÌã∞Ìå©Ìä∏ Ïù¥Î¶ÑÏóêÏÑú prefix Ï∂îÏ∂ú (frontend-build-{prefix})
                const artifactPrefix = buildArtifact.name.replace('frontend-build-', '');

                // version_tag Ï∂îÏ∂ú
                let versionTag;
                if (branch === 'main') {
                  // main Î∏åÎûúÏπò: v1.0.0-abc1234 -> v1.0.0
                  versionTag = artifactPrefix.replace(/-[a-f0-9]{7}$/, '');
                } else {
                  // develop Î∏åÎûúÏπò: develop-abc1234
                  versionTag = artifactPrefix;
                }

                console.log(`‚úÖ Found artifact from run #${run.run_number}`);
                console.log(`   Run ID: ${run.id}`);
                console.log(`   SHA: ${sha}`);
                console.log(`   Version Tag: ${versionTag}`);
                console.log(`   Artifact Prefix: ${artifactPrefix}`);
                console.log(`   Created: ${run.created_at}`);

                core.setOutput('run_id', run.id.toString());
                core.setOutput('sha', sha);
                core.setOutput('sha_short', sha_short);
                core.setOutput('version_tag', versionTag);
                core.setOutput('artifact_prefix', artifactPrefix);
                core.setOutput('run_number', run.run_number.toString());
                return;
              }
            }

            core.setFailed(`‚ùå No artifacts found in recent CI runs for branch: ${branch}`);

      - name: Set Deployment Variables
        id: deploy-vars
        run: |
          if [ "${{ inputs.use_latest_artifact }}" == "true" ] && [ -z "${{ inputs.run_id }}" ]; then
            echo "run_id=${{ steps.find-artifact.outputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ steps.find-artifact.outputs.sha }}" >> $GITHUB_OUTPUT
            echo "sha_short=${{ steps.find-artifact.outputs.sha_short }}" >> $GITHUB_OUTPUT
            echo "version_tag=${{ steps.find-artifact.outputs.version_tag }}" >> $GITHUB_OUTPUT
            echo "artifact_prefix=${{ steps.find-artifact.outputs.artifact_prefix }}" >> $GITHUB_OUTPUT
            echo "üì¶ Using latest artifact from run #${{ steps.find-artifact.outputs.run_number }}"
          else
            SHA="${{ inputs.sha }}"
            SHA_SHORT="${SHA:0:7}"
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
            echo "version_tag=${{ inputs.version_tag }}" >> $GITHUB_OUTPUT
            echo "artifact_prefix=${{ inputs.artifact_prefix }}" >> $GITHUB_OUTPUT
            echo "üì¶ Using manually specified artifact"
          fi

          # Î∏åÎûúÏπòÎ≥Ñ version_path ÏÑ§Ï†ï (S3 Í≤ΩÎ°úÏö©)
          VERSION_TAG="${{ inputs.version_tag }}"
          if [ -z "$VERSION_TAG" ]; then
            VERSION_TAG="${{ steps.find-artifact.outputs.version_tag }}"
          fi

          if [[ "$VERSION_TAG" == v* ]]; then
            # Main Î∏åÎûúÏπò: v1.0.0 -> v1.0.0
            echo "version_path=${VERSION_TAG}" >> $GITHUB_OUTPUT
          else
            # Develop Î∏åÎûúÏπò: develop
            echo "version_path=develop" >> $GITHUB_OUTPUT
          fi

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ steps.deploy-vars.outputs.artifact_prefix }}
          path: build-output
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Extract Build Artifact
        run: |
          cd build-output
          tar -xzf next-build.tar.gz
          rm next-build.tar.gz
          echo "‚úÖ Build artifacts extracted"
          ls -la

      - name: Download Deployment Files
        uses: actions/download-artifact@v4
        with:
          name: frontend-files-${{ steps.deploy-vars.outputs.artifact_prefix }}
          path: build-output
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Verify Downloaded Files
        run: |
          echo "=== Verifying downloaded files ==="
          ls -la build-output/
          if [ -d "build-output/.next" ]; then
            echo "‚úÖ .next directory found"
          else
            echo "‚ùå .next directory not found"
            exit 1
          fi
          if [ -f "build-output/package.json" ]; then
            echo "‚úÖ package.json found"
          else
            echo "‚ùå package.json not found"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # ÎπåÎìú ÏïÑÌã∞Ìå©Ìä∏ ÏïïÏ∂ï ÌõÑ S3Ïóê ÏóÖÎ°úÎìú
      - name: Compress and Upload to S3
        id: s3_upload
        run: |
          set -euo pipefail
          cd build-output

          # ÏïÑÏπ¥Ïù¥Î∏å Ïù¥Î¶Ñ ÏÉùÏÑ±
          ARTIFACT_PREFIX="${{ steps.deploy-vars.outputs.artifact_prefix }}"
          VERSION_PATH="${{ steps.deploy-vars.outputs.version_path }}"

          # develop Î∏åÎûúÏπòÎäî ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä
          if [[ "$VERSION_PATH" == "develop" ]]; then
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            ARCHIVE_NAME="frontend-deploy-${ARTIFACT_PREFIX}-${TIMESTAMP}.tar.gz"
          else
            # main Î∏åÎûúÏπò: frontend-deploy-v1.0.0-abc1234.tar.gz
            ARCHIVE_NAME="frontend-deploy-${ARTIFACT_PREFIX}.tar.gz"
          fi

          echo "üì¶ Archive name: ${ARCHIVE_NAME}"
          echo "üìÅ S3 path: artifacts/frontend/${VERSION_PATH}/"

          # .next, package.json, pnpm-lock.yaml, next.config.mjs, public/ Îì±ÏùÑ tarÎ°ú ÏïïÏ∂ï
          tar -czf "${ARCHIVE_NAME}" .next package.json pnpm-lock.yaml next.config.mjs public/ 2>/dev/null || \
          tar -czf "${ARCHIVE_NAME}" .next package.json 2>/dev/null || exit 1

          # ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù (100KB Ïù¥ÏÉÅ)
          [ $(stat -f%z "${ARCHIVE_NAME}" 2>/dev/null || stat -c%s "${ARCHIVE_NAME}" 2>/dev/null || echo 0) -gt 100000 ] || exit 1

          # S3 ÏóÖÎ°úÎìú (Î≤ÑÏ†ÑÎ≥Ñ Ìè¥Îçî Íµ¨Ï°∞)
          S3_KEY="artifacts/frontend/${VERSION_PATH}/${ARCHIVE_NAME}"
          aws s3 cp "${ARCHIVE_NAME}" "s3://${{ secrets.S3_ARTIFACTS_BUCKET }}/${S3_KEY}"

          echo "s3_key=${S3_KEY}" >> $GITHUB_OUTPUT
          echo "archive_name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT

      # SSMÏùÑ ÌÜµÌï¥ EC2 Ïù∏Ïä§ÌÑ¥Ïä§Ïóê Î∞∞Ìè¨
      - name: Deploy via SSM
        env:
          SERVER_BASE_PATH: ${{ secrets.SERVER_BASE_PATH }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
          S3_BUCKET: ${{ secrets.S3_ARTIFACTS_BUCKET }}
          S3_KEY: ${{ steps.s3_upload.outputs.s3_key }}
          ARTIFACT_PREFIX: ${{ steps.deploy-vars.outputs.artifact_prefix }}
          VERSION_TAG: ${{ steps.deploy-vars.outputs.version_tag }}
        run: |
          set -euo pipefail

          BASE_PATH="$SERVER_BASE_PATH"
          FE_DIR="${BASE_PATH}/app/frontend"
          BACKUP_DIR="${BASE_PATH}/backups/frontend"
          TEMP_DIR="${BASE_PATH}/app/frontend_deploy_temp"
          ARCHIVE_PATH="${TEMP_DIR}/frontend-deploy.tar.gz"
          PM2_CONFIG="${BASE_PATH}/infra/pm2/ecosystem.config.js"
          ARTIFACT_PREFIX="$ARTIFACT_PREFIX"

          DEPLOY_SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          BASE_PATH="$1"
          FE_DIR="$2"
          BACKUP_DIR="$3"
          TEMP_DIR="$4"
          ARCHIVE_PATH="$5"
          PM2_CONFIG="$6"
          S3_BUCKET="$7"
          S3_KEY="$8"
          HEALTH_CHECK_URL="$9"
          ARTIFACT_PREFIX="${10}"

          APP_NAME="frontend"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BACKUP_NAME="backup-${ARTIFACT_PREFIX}"

          trap 'sudo -u ubuntu pm2 status || true; exit $?' ERR

          echo "============================================"
          echo "Re-Fit FE Î∞∞Ìè¨ ÏãúÏûë: $(date)"
          echo "============================================"

          # ÎîîÎ†âÌÜ†Î¶¨ Ï§ÄÎπÑ
          mkdir -p "${BACKUP_DIR}" "${TEMP_DIR}"

          # S3ÏóêÏÑú ÏïïÏ∂ïÎêú ÏïÑÌã∞Ìå©Ìä∏ Îã§Ïö¥Î°úÎìú
          aws s3 cp "s3://${S3_BUCKET}/${S3_KEY}" "${ARCHIVE_PATH}" --region ap-northeast-2

          # ÏïÑÏπ¥Ïù¥Î∏å ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù (100KB Ïù¥ÏÉÅ)
          [ $(stat -f%z "${ARCHIVE_PATH}" 2>/dev/null || stat -c%s "${ARCHIVE_PATH}" 2>/dev/null || echo 0) -gt 100000 ] || exit 1

          # ÌôòÍ≤Ω Î≥ÄÏàò Ï≤¥ÌÅ¨ (ÏÑ†ÌÉùÏ†Å)
          if [ -f "${FE_DIR}/.env.production" ]; then
            echo "‚úÖ .env.production ÌååÏùº Î∞úÍ≤¨ (Îü∞ÌÉÄÏûÑ ÌôòÍ≤Ω Î≥ÄÏàò ÏÇ¨Ïö©)"
          else
            echo "‚ÑπÔ∏è  .env.production ÌååÏùº ÏóÜÏùå (ÎπåÎìú ÏãúÏ†ê ÌôòÍ≤Ω Î≥ÄÏàò ÏÇ¨Ïö©)"
          fi

          # Í∏∞Ï°¥ ÌååÏùº Î∞±ÏóÖ
          if [ -d "${FE_DIR}/.next" ]; then
            echo "Í∏∞Ï°¥ ÌååÏùº Î∞±ÏóÖ Ï§ë..."
            BACKUP_PATH="${BACKUP_DIR}/${BACKUP_NAME}"
            mkdir -p "${BACKUP_PATH}"

            # .next Î∞±ÏóÖ
            cp -r "${FE_DIR}/.next" "${BACKUP_PATH}/"

            # ÌôòÍ≤Ω ÏÑ§Ï†ï Î∞è ÏùòÏ°¥ÏÑ± ÌååÏùº Î∞±ÏóÖ
            [ -f "${FE_DIR}/package.json" ] && cp "${FE_DIR}/package.json" "${BACKUP_PATH}/"
            [ -f "${FE_DIR}/pnpm-lock.yaml" ] && cp "${FE_DIR}/pnpm-lock.yaml" "${BACKUP_PATH}/"
            [ -f "${FE_DIR}/next.config.mjs" ] && cp "${FE_DIR}/next.config.mjs" "${BACKUP_PATH}/"

            # public Ìè¥Îçî Î∞±ÏóÖ
            [ -d "${FE_DIR}/public" ] && cp -r "${FE_DIR}/public" "${BACKUP_PATH}/"

            echo "‚úÖ Î∞±ÏóÖ ÏôÑÎ£å: ${BACKUP_PATH}"
          fi

          # ÏûÑÏãú ÎîîÎ†âÌÜ†Î¶¨Ïóê ÏïïÏ∂ï Ìï¥Ï†ú
          cd "${TEMP_DIR}"
          tar -xzf "${ARCHIVE_PATH}"
          rm -f "${ARCHIVE_PATH}"

          # ÌååÏùº Í≤ÄÏ¶ù
          if [ ! -d "${TEMP_DIR}/.next" ]; then
            echo "‚ùå ÏóêÎü¨: ÎπåÎìú ÏïÑÌã∞Ìå©Ìä∏(.next)Í∞Ä ÏóÜÏäµÎãàÎã§."
            rm -rf "${TEMP_DIR}"
            exit 1
          fi

          if [ ! -f "${TEMP_DIR}/package.json" ]; then
            echo "‚ùå ÏóêÎü¨: package.jsonÏù¥ ÏóÜÏäµÎãàÎã§."
            rm -rf "${TEMP_DIR}"
            exit 1
          fi

          # Atomic Switch: ÏÉà ÎπåÎìúÎ°ú ÍµêÏ≤¥
          echo "ÏÉà ÎπåÎìú ÌååÏùº ÍµêÏ≤¥ Ï§ë..."
          rm -rf "${FE_DIR}/.next"
          mv "${TEMP_DIR}/.next" "${FE_DIR}/.next"

          # ÌïÑÏàò ÌååÏùº ÏóÖÎç∞Ïù¥Ìä∏
          cp "${TEMP_DIR}/package.json" "${FE_DIR}/package.json"
          [ -f "${TEMP_DIR}/pnpm-lock.yaml" ] && cp "${TEMP_DIR}/pnpm-lock.yaml" "${FE_DIR}/pnpm-lock.yaml" || true
          [ -f "${TEMP_DIR}/next.config.mjs" ] && cp "${TEMP_DIR}/next.config.mjs" "${FE_DIR}/next.config.mjs" || true

          # public Ìè¥Îçî ÏóÖÎç∞Ïù¥Ìä∏
          if [ -d "${TEMP_DIR}/public" ]; then
            rm -rf "${FE_DIR}/public"
            mv "${TEMP_DIR}/public" "${FE_DIR}/public"
          fi

          # ÏûÑÏãú ÎîîÎ†âÌÜ†Î¶¨ Ï†ïÎ¶¨
          rm -rf "${TEMP_DIR}"

          # Í∂åÌïú ÏÑ§Ï†ï
          sudo chown -R ubuntu:ubuntu "${FE_DIR}" 2>/dev/null || true

          # ÌîÑÎ°úÎçïÏÖò ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
          echo "ÌîÑÎ°úÎçïÏÖò ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò Ï§ë..."
          cd "${FE_DIR}"

          # ÌîÑÎ°úÎçïÏÖò ÏùòÏ°¥ÏÑ±Îßå ÏÑ§Ïπò
          sudo -u ubuntu pnpm install --prod --frozen-lockfile --ignore-scripts || exit 1

          # PM2Î°ú Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ïû¨ÏãúÏûë ÎòêÎäî ÏãúÏûë
          if sudo -u ubuntu pm2 describe ${APP_NAME} > /dev/null 2>&1; then
            echo "Í∏∞Ï°¥ ÌîÑÎ°úÏÑ∏Ïä§ Ïû¨ÏãúÏûë (Reload)..."
            if ! sudo -u ubuntu pm2 reload ${APP_NAME} --update-env; then
              echo "Reload Ïã§Ìå®, ÌîÑÎ°úÏÑ∏Ïä§ ÏÇ≠Ï†ú ÌõÑ ÏÉàÎ°ú ÏãúÏûë..."
              sudo -u ubuntu pm2 delete ${APP_NAME}
              sudo -u ubuntu pm2 start ${PM2_CONFIG} --only ${APP_NAME} --env production || exit 1
            fi
          else
            echo "Ïã†Í∑ú ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë..."
            sudo -u ubuntu pm2 start ${PM2_CONFIG} --only ${APP_NAME} --env production || exit 1
          fi

          sleep 2
          sudo -u ubuntu pm2 describe ${APP_NAME} > /dev/null || exit 1

          # Caddy Î¶¨Î°úÎìú
          systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
          sleep 15

          # Ìó¨Ïä§Ï≤¥ÌÅ¨ (ÏµúÎåÄ 5Ìöå Ïû¨ÏãúÎèÑ)
          for i in {1..5}; do
            HTTP_STATUS=$(timeout 5 curl -s -o /dev/null -w "%{http_code}" "${HEALTH_CHECK_URL}" 2>/dev/null || echo "000")
            if [ "${HTTP_STATUS}" = "200" ]; then
              echo "‚úÖ Î∞∞Ìè¨ ÏÑ±Í≥µ! (HTTP ${HTTP_STATUS})"
              sudo -u ubuntu pm2 save 2>/dev/null || true
              (find ${BACKUP_DIR} -name "backup-*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null) &
              echo "============================================"
              echo "‚úÖ Re-Fit FE Î∞∞Ìè¨ ÏôÑÎ£å: $(date)"
              echo "   Version: ${ARTIFACT_PREFIX}"
              echo "============================================"
              exit 0
            fi
            [ $i -lt 5 ] && sleep 3
          done

          # Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå® Ïãú Î°§Î∞±
          echo "‚ö†Ô∏è  Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®, Î°§Î∞± ÏãúÎèÑ Ï§ë..."
          BACKUP_PATH="${BACKUP_DIR}/${BACKUP_NAME}"
          if [ -d "${BACKUP_PATH}" ]; then
            rm -rf "${FE_DIR}/.next"
            cp -r "${BACKUP_PATH}/.next" "${FE_DIR}/.next"

            # ÏÑ§Ï†ï ÌååÏùºÎèÑ Î°§Î∞±
            [ -f "${BACKUP_PATH}/package.json" ] && cp "${BACKUP_PATH}/package.json" "${FE_DIR}/package.json"
            [ -f "${BACKUP_PATH}/pnpm-lock.yaml" ] && cp "${BACKUP_PATH}/pnpm-lock.yaml" "${FE_DIR}/pnpm-lock.yaml"
            [ -f "${BACKUP_PATH}/next.config.mjs" ] && cp "${BACKUP_PATH}/next.config.mjs" "${FE_DIR}/next.config.mjs"

            sudo chown -R ubuntu:ubuntu "${FE_DIR}" 2>/dev/null || true
            sudo -u ubuntu pm2 reload ${APP_NAME}
            sleep 5
            HTTP_STATUS=$(timeout 10 curl -s -o /dev/null -w "%{http_code}" "${HEALTH_CHECK_URL}" 2>/dev/null || echo "000")
            if [ "${HTTP_STATUS}" = "200" ]; then
              echo "‚úÖ Î°§Î∞± ÏÑ±Í≥µ"
              sudo -u ubuntu pm2 save 2>/dev/null || true
            else
              echo "‚ùå Î°§Î∞± ÌõÑÏóêÎèÑ Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®"
            fi
          fi
          exit 1
          SCRIPT_END
          )

          # SSM Î™ÖÎ†π Ïã§Ìñâ (base64 Ïù∏ÏΩîÎî©ÏúºÎ°ú ÌäπÏàòÎ¨∏Ïûê Ïù¥Ïä§ÏºÄÏù¥ÌîÑ Î¨∏Ï†ú Î∞©ÏßÄ)
          DEPLOY_SCRIPT_ENCODED=$(echo "$DEPLOY_SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$DEPLOY_SCRIPT_ENCODED' | base64 -d | bash -s -- '$BASE_PATH' '$FE_DIR' '$BACKUP_DIR' '$TEMP_DIR' '$ARCHIVE_PATH' '$PM2_CONFIG' '$S3_BUCKET' '$S3_KEY' '$HEALTH_CHECK_URL' '$ARTIFACT_PREFIX'\""
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 600 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)

          [ -n "$COMMAND_ID" ] || exit 1

          # SSM Î™ÖÎ†π Ïã§Ìñâ ÏÉÅÌÉú ÌôïÏù∏ (ÏµúÎåÄ 60Ìöå, 5Î∂Ñ)
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")
            
            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi
            sleep 5
          done
          exit 1

      - name: Notify Discord - Deployment Complete
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          BRANCH: ${{ inputs.branch }}
          VERSION_TAG: ${{ steps.deploy-vars.outputs.version_tag }}
          SHA: ${{ steps.deploy-vars.outputs.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "üöÄ FE Î∞∞Ìè¨ ÏôÑÎ£å",
              "description": "Î∞∞Ìè¨Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.",
              "color": 3066993,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit Frontend", "inline": true},
                {"name": "Î≤ÑÏ†Ñ", "value": "\`$VERSION_TAG\`", "inline": true},
                {"name": "Î∏åÎûúÏπò", "value": "\`$BRANCH\`", "inline": true},
                {"name": "Ïª§Î∞ã SHA", "value": "\`${SHA:0:7}\`", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit Deployment System" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"

      - name: Notify Discord on Deploy Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          BRANCH: ${{ inputs.branch }}
          VERSION_TAG: ${{ steps.deploy-vars.outputs.version_tag }}
          SHA: ${{ steps.deploy-vars.outputs.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          VERSION="${VERSION_TAG:-unknown}"
          SHA_SHORT="${SHA:0:7}"

          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "üö® FE Î∞∞Ìè¨ Ïã§Ìå®",
              "description": "Î∞∞Ìè¨ ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î°úÍ∑∏Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.",
              "color": 15158332,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit Frontend", "inline": true},
                {"name": "Î≤ÑÏ†Ñ", "value": "\`$VERSION\`", "inline": true},
                {"name": "Î∏åÎûúÏπò", "value": "\`$BRANCH\`", "inline": true},
                {"name": "Ïª§Î∞ã SHA", "value": "\`$SHA_SHORT\`", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit Deployment System" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"
