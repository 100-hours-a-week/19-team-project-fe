name: Re-Fit Frontend CD

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI workflow run ID (ìë™ ì…ë ¥ ë˜ëŠ” ì§ì ‘ ì…ë ¥)'
        required: false
        type: string
      sha:
        description: 'Commit SHA (ìë™ ì…ë ¥ ë˜ëŠ” ì§ì ‘ ì…ë ¥)'
        required: false
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: choice
        default: 'develop'
        options:
          - develop
          - main
      use_latest_artifact:
        description: 'run_id/shaë¥¼ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì„ íƒí•œ ë¸Œëœì¹˜ì˜ ìµœì‹  ì•„í‹°íŒ©íŠ¸ ì‚¬ìš©'
        required: true
        type: boolean
        default: true

env:
  NODE_VERSION: 22
  PNPM_VERSION: 10

jobs:
  deploy:
    # Release job ì„±ê³µ í›„ íŠ¸ë¦¬ê±°ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    environment: ${{ inputs.branch == 'main' && 'production' || 'development' }}
    steps:
      - name: Find Latest Artifact (if needed)
        if: inputs.use_latest_artifact == true && (inputs.run_id == '' || inputs.sha == '')
        id: find-artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const branch = '${{ inputs.branch }}';
            console.log(`ğŸ” Finding latest artifact for branch: ${branch}`);

            // CI ì›Œí¬í”Œë¡œìš°ì˜ ìµœê·¼ ì„±ê³µí•œ ì‹¤í–‰ ì°¾ê¸°
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: branch,
              status: 'success',
              per_page: 10
            });

            if (runs.data.workflow_runs.length === 0) {
              core.setFailed(`âŒ No successful CI runs found for branch: ${branch}`);
              return;
            }

            // ì•„í‹°íŒ©íŠ¸ê°€ ìˆëŠ” ìµœì‹  ì‹¤í–‰ ì°¾ê¸°
            for (const run of runs.data.workflow_runs) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id
              });

              const buildArtifact = artifacts.data.artifacts.find(
                a => a.name.startsWith('next-build-artifact-')
              );

              if (buildArtifact) {
                const sha = run.head_sha;
                console.log(`âœ… Found artifact from run #${run.run_number}`);
                console.log(`   Run ID: ${run.id}`);
                console.log(`   SHA: ${sha}`);
                console.log(`   Created: ${run.created_at}`);

                core.setOutput('run_id', run.id.toString());
                core.setOutput('sha', sha);
                core.setOutput('run_number', run.run_number.toString());
                return;
              }
            }

            core.setFailed(`âŒ No artifacts found in recent CI runs for branch: ${branch}`);

      - name: Set Deployment Variables
        id: deploy-vars
        run: |
          if [ "${{ inputs.use_latest_artifact }}" == "true" ] && [ -z "${{ inputs.run_id }}" ]; then
            echo "run_id=${{ steps.find-artifact.outputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ steps.find-artifact.outputs.sha }}" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Using latest artifact from run #${{ steps.find-artifact.outputs.run_number }}"
          else
            echo "run_id=${{ inputs.run_id }}" >> $GITHUB_OUTPUT
            echo "sha=${{ inputs.sha }}" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Using manually specified artifact"
          fi

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: next-build-artifact-${{ steps.deploy-vars.outputs.sha }}
          path: build-output/.next
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Download Deployment Files
        uses: actions/download-artifact@v4
        with:
          name: deploy-files-${{ steps.deploy-vars.outputs.sha }}
          path: build-output
          github-token: ${{ secrets.PAT }}
          run-id: ${{ steps.deploy-vars.outputs.run_id }}

      - name: Verify Downloaded Files
        run: |
          echo "=== Verifying downloaded files ==="
          ls -la build-output/
          if [ -d "build-output/.next" ]; then
            echo "âœ… .next directory found"
          else
            echo "âŒ .next directory not found"
            exit 1
          fi
          if [ -f "build-output/package.json" ]; then
            echo "âœ… package.json found"
          else
            echo "âŒ package.json not found"
            exit 1
          fi

      - name: Transfer Files to Server (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: 'build-output/*'
          target: '/home/ubuntu/refit/app/frontend_deploy_temp'
          strip_components: 1

      - name: Execute Remote Deployment Script (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            # ê²½ë¡œ ì •ì˜
            FE_DIR=/home/ubuntu/refit/app/frontend
            BACKUP_DIR=/home/ubuntu/refit/backups/frontend
            LOG_DIR=/home/ubuntu/refit/logs/frontend
            TEMP_DIR=/home/ubuntu/refit/app/frontend_deploy_temp
            PM2_CONFIG=/home/ubuntu/refit/infra/pm2/ecosystem.config.js
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            APP_NAME="frontend"

            echo "============================================"
            echo "Re-Fit FE ë°°í¬ ì‹œì‘: $(date)"
            echo "============================================"

            # 1. ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p $BACKUP_DIR $LOG_DIR

            # 2. í™˜ê²½ ë³€ìˆ˜ ì²´í¬ (ì„ íƒì , ëŸ°íƒ€ì„ í™˜ê²½ ë³€ìˆ˜ê°€ í•„ìš”í•œ ê²½ìš°)
            if [ -f "$FE_DIR/.env.production" ]; then
              echo "âœ… .env.production íŒŒì¼ ë°œê²¬ (ëŸ°íƒ€ì„ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)"
            else
              echo "â„¹ï¸  .env.production íŒŒì¼ ì—†ìŒ (ë¹Œë“œ ì‹œì  í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)"
            fi

            # 3. ë°±ì—… (ê¸°ì¡´ .next, node_modules)
            if [ -d "$FE_DIR/.next" ]; then
              echo "ê¸°ì¡´ .next ë°±ì—… ì¤‘..."
              cp -r $FE_DIR/.next $BACKUP_DIR/next_$TIMESTAMP
              echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_DIR/next_$TIMESTAMP"
            fi

            # 4. ì „ì†¡ëœ íŒŒì¼ ê²€ì¦
            if [ ! -d "$TEMP_DIR/.next" ]; then
              echo "âŒ ì—ëŸ¬: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸(.next)ê°€ ì „ì†¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              rm -rf $TEMP_DIR
              exit 1
            fi

            if [ ! -f "$TEMP_DIR/package.json" ]; then
              echo "âŒ ì—ëŸ¬: package.jsonì´ ì „ì†¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              rm -rf $TEMP_DIR
              exit 1
            fi

            # 5. ìƒˆ ë¹Œë“œë¡œ êµì²´ (Atomic Switch)
            echo "ìƒˆ ë¹Œë“œ íŒŒì¼ êµì²´ ì¤‘..."
            rm -rf $FE_DIR/.next
            mv $TEMP_DIR/.next $FE_DIR/.next

            # 6. í•„ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸
            cp $TEMP_DIR/package.json $FE_DIR/package.json
            cp $TEMP_DIR/pnpm-lock.yaml $FE_DIR/pnpm-lock.yaml 2>/dev/null || true
            cp $TEMP_DIR/next.config.ts $FE_DIR/next.config.ts 2>/dev/null || true

            # public í´ë” ì—…ë°ì´íŠ¸
            if [ -d "$TEMP_DIR/public" ]; then
              rm -rf $FE_DIR/public
              mv $TEMP_DIR/public $FE_DIR/public
            fi

            # ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
            rm -rf $TEMP_DIR

            # 7. ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ í™˜ê²½)
            echo "í”„ë¡œë•ì…˜ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            cd $FE_DIR

            # NVM í™˜ê²½ ë¡œë“œ
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # prepare ìŠ¤í¬ë¦½íŠ¸ ë¬´ì‹œí•˜ê³  í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
            pnpm install --prod --frozen-lockfile --ignore-scripts

            # 8. PM2ë¥¼ ì´ìš©í•œ ë¬´ì¤‘ë‹¨ ì¬ì‹œì‘
            if pm2 describe $APP_NAME > /dev/null 2>&1; then
              echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ (Reload)..."
              pm2 reload $APP_NAME --update-env
            else
              echo "ì‹ ê·œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
              pm2 start $PM2_CONFIG --only $APP_NAME --env production
            fi

            # 9. Caddy ë¦¬ë¡œë“œ
            if systemctl is-active --quiet caddy; then
              echo "Caddy ì›¹ì„œë²„ ë¦¬ë¡œë“œ ì¤‘..."
              sudo systemctl reload caddy
            fi

            # 10. ë°°í¬ ê²€ì¦
            echo "ë°°í¬ ê²€ì¦ ì¤‘ (5ì´ˆ ëŒ€ê¸°)..."
            sleep 5
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ë°°í¬ ì„±ê³µ! (HTTP $HTTP_STATUS)"
              pm2 save

              # ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (7ì¼ ì´ìƒ)
              find $BACKUP_DIR -name "next_*" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
            else
              echo "âš ï¸  ë°°í¬ ì´ìƒ ê°ì§€! (HTTP $HTTP_STATUS)"
              echo "ë¡œê·¸ í™•ì¸: pm2 logs $APP_NAME"
              echo "ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš°: mv $BACKUP_DIR/next_$TIMESTAMP $FE_DIR/.next && pm2 reload $APP_NAME"
              exit 1
            fi

            echo "============================================"
            echo "âœ… Re-Fit FE ë°°í¬ ì™„ë£Œ: $(date)"
            echo "============================================"

      - name: Notify Discord on Result
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
          BRANCH: ${{ inputs.branch }}
          SHA: ${{ steps.deploy-vars.outputs.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ë° ì´ëª¨ì§€ ì„¤ì •
          if [ "$STATUS" = "success" ]; then
            COLOR=3066993
            EMOJI="âœ…"
          else
            COLOR=15158332
            EMOJI="ğŸš¨"
          fi

          # JSON í˜ì´ë¡œë“œ ìƒì„±
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI FE ë°°í¬ ê²°ê³¼: $STATUS",
              "color": $COLOR,
              "fields": [
                {"name": "ì„œë¹„ìŠ¤", "value": "Re-Fit Frontend", "inline": true},
                {"name": "ë¸Œëœì¹˜", "value": "\`$BRANCH\`", "inline": true},
                {"name": "ì»¤ë°‹ SHA", "value": "\`$SHA\`", "inline": false},
                {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ìƒì„¸ ë³´ê¸°](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit Deployment System" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          # ì „ì†¡
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"
