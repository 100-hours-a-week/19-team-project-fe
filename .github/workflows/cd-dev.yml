name: Re-Fit Frontend CD (Dev)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag (e.g., develop-abc1234)'
        required: false
        type: string
      sha:
        description: 'Commit SHA'
        required: false
        type: string
      run_id:
        description: 'CI workflow run ID'
        required: false
        type: string
      use_latest:
        description: 'image_tagÎ•º ÏûÖÎ†•ÌïòÏßÄ ÏïäÏúºÎ©¥ develop-latest ÌÉúÍ∑∏ ÏÇ¨Ïö©'
        required: true
        type: boolean
        default: true

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Set Deployment Variables
        id: deploy-vars
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
            echo "üì¶ Using specified image tag: ${IMAGE_TAG}"
          else
            IMAGE_TAG="develop-latest"
            echo "üì¶ Using latest develop image"
          fi

          SHA="${{ inputs.sha }}"
          SHA_SHORT="${SHA:0:7}"

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Verify Image Exists in ECR
        run: |
          IMAGE_TAG="${{ steps.deploy-vars.outputs.image_tag }}"
          REPO="${{ secrets.ECR_REPOSITORY_FRONTEND }}"

          aws ecr describe-images \
            --repository-name "${REPO}" \
            --image-ids imageTag="${IMAGE_TAG}" \
            --region ap-northeast-2 > /dev/null 2>&1

          if [ $? -eq 0 ]; then
            echo "‚úÖ Image found: ${REPO}:${IMAGE_TAG}"
          else
            echo "‚ùå Image not found: ${REPO}:${IMAGE_TAG}"
            exit 1
          fi

      - name: Deploy to Dev Server via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT }}
          script: |
            set -euo pipefail

            echo "============================================"
            echo "Re-Fit FE Í∞úÎ∞ú ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÏãúÏûë: $(date)"
            echo "============================================"

            ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
            ECR_REPO="${{ secrets.ECR_REPOSITORY_FRONTEND }}"
            IMAGE_TAG="${{ steps.deploy-vars.outputs.image_tag }}"
            FULL_IMAGE="${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"
            COMPOSE_DIR="${{ secrets.DEV_COMPOSE_DIR }}"

            echo "üê≥ Image: ${FULL_IMAGE}"

            # ECR Î°úÍ∑∏Ïù∏
            aws ecr get-login-password --region ap-northeast-2 | \
              docker login --username AWS --password-stdin "${ECR_REGISTRY}"

            # docker-compose.ymlÏù¥ ÏûàÎäî ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
            cd "${COMPOSE_DIR}"

            # Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏Î•º .env ÌååÏùºÏóê ÏòÅÍµ¨ Ï†ÄÏû•
            ENV_FILE="${COMPOSE_DIR}/.env"
            if grep -q '^FRONTEND_TAG=' "${ENV_FILE}" 2>/dev/null; then
              sed -i "s|^FRONTEND_TAG=.*|FRONTEND_TAG=${IMAGE_TAG}|" "${ENV_FILE}"
            else
              echo "FRONTEND_TAG=${IMAGE_TAG}" >> "${ENV_FILE}"
            fi

            echo "üì• Pulling new image..."
            docker compose pull frontend

            echo "üîÑ Restarting frontend service..."
            docker compose up -d frontend

            # Ïù¥Ï†Ñ Ïù¥ÎØ∏ÏßÄ Ï†ïÎ¶¨
            docker image prune -f 2>/dev/null || true

            echo "============================================"
            echo "‚úÖ Re-Fit FE Í∞úÎ∞ú ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÏôÑÎ£å: $(date)"
            echo "   Image: ${FULL_IMAGE}"
            echo "============================================"

      - name: Health Check
        run: |
          HEALTH_URL="${{ secrets.DEV_HEALTH_CHECK_URL }}"

          if [ -z "$HEALTH_URL" ]; then
            echo "‚ö†Ô∏è  DEV_HEALTH_CHECK_URLÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïÑ Ìó¨Ïä§Ï≤¥ÌÅ¨Î•º Í±¥ÎÑàÎúÅÎãàÎã§."
            exit 0
          fi

          echo "üè• Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏãúÏûë: ${HEALTH_URL}"

          for i in {1..10}; do
            HTTP_STATUS=$(timeout 5 curl -s -o /dev/null -w "%{http_code}" "${HEALTH_URL}" 2>/dev/null || echo "000")
            if [ "${HTTP_STATUS}" = "200" ]; then
              echo "‚úÖ Ìó¨Ïä§Ï≤¥ÌÅ¨ ÏÑ±Í≥µ! (HTTP ${HTTP_STATUS})"
              exit 0
            fi
            echo "  ‚è≥ ÏãúÎèÑ ${i}/10 - HTTP ${HTTP_STATUS}"
            [ $i -lt 10 ] && sleep 5
          done

          echo "‚ùå Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïã§Ìå®"
          exit 1

      - name: Notify Discord - Dev Deployment Complete
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          IMAGE_TAG: ${{ steps.deploy-vars.outputs.image_tag }}
          SHA: ${{ steps.deploy-vars.outputs.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          [ -z "$DISCORD_WEBHOOK" ] && echo "Discord webhook not configured" && exit 0

          SHA_SHORT="${SHA:0:7}"
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "üöÄ FE Í∞úÎ∞ú ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÏôÑÎ£å",
              "description": "Í∞úÎ∞ú ÏÑúÎ≤Ñ Î∞∞Ìè¨Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.",
              "color": 3447003,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit Frontend (Dev)", "inline": true},
                {"name": "Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏", "value": "\`$IMAGE_TAG\`", "inline": true},
                {"name": "Ïª§Î∞ã SHA", "value": "\`$SHA_SHORT\`", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit Dev Deployment System" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"

      - name: Notify Discord on Dev Deploy Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          IMAGE_TAG: ${{ steps.deploy-vars.outputs.image_tag }}
          SHA: ${{ steps.deploy-vars.outputs.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          [ -z "$DISCORD_WEBHOOK" ] && echo "Discord webhook not configured" && exit 0

          SHA_SHORT="${SHA:0:7}"
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "üö® FE Í∞úÎ∞ú ÏÑúÎ≤Ñ Î∞∞Ìè¨ Ïã§Ìå®",
              "description": "Í∞úÎ∞ú ÏÑúÎ≤Ñ Î∞∞Ìè¨Í∞Ä Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î°úÍ∑∏Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.",
              "color": 15158332,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit Frontend (Dev)", "inline": true},
                {"name": "Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏", "value": "\`$IMAGE_TAG\`", "inline": true},
                {"name": "Ïª§Î∞ã SHA", "value": "\`$SHA_SHORT\`", "inline": true},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit Dev Deployment System" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"
