name: System Rollback

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation Mode'
        required: true
        type: choice
        options:
          - list
          - restore
        default: 'list'
      backup_id:
        description: 'Backup ID to restore (required for restore mode, e.g., next_20240127120000)'
        required: false
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Execute Rollback Operation
        env:
          SERVER_BASE_PATH: ${{ secrets.SERVER_BASE_PATH }}
          EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
          HEALTH_CHECK_URL: ${{ secrets.HEALTH_CHECK_URL }}
          MODE: ${{ inputs.mode }}
          BACKUP_ID: ${{ inputs.backup_id }}
        run: |
          set -euo pipefail

          BASE_PATH="$SERVER_BASE_PATH"
          FE_DIR="${BASE_PATH}/app/frontend"
          BACKUP_DIR="${BASE_PATH}/backups/frontend"

          SCRIPT=$(cat <<'SCRIPT_END'
          set -euo pipefail
          BASE_PATH="$1"
          FE_DIR="$2"
          BACKUP_DIR="$3"
          MODE="$4"
          BACKUP_ID="$5"
          HEALTH_CHECK_URL="$6"

          APP_NAME="frontend"

          echo "============================================"
          echo "Re-Fit System Rollback Operation: ${MODE}"
          echo "============================================"

          if [ "${MODE}" = "list" ]; then
            echo "üìÇ Available Backups (Latest 10):"
            if [ -d "${BACKUP_DIR}" ]; then
              ls -lt "${BACKUP_DIR}" | grep "next_" | head -n 10 | awk '{print $9, $6, $7, $8}'
            else
              echo "No backups directory found."
            fi
            exit 0
          fi

          if [ "${MODE}" = "restore" ]; then
            TARGET_BACKUP=""

            if [ -z "${BACKUP_ID}" ]; then
              # Í∞ÄÏû• ÏµúÏã† Î∞±ÏóÖ Ï∞æÍ∏∞
              TARGET_BACKUP=$(ls -td "${BACKUP_DIR}/next_"* | head -n 1)
              echo "‚ö†Ô∏è Backup ID not specified. Using latest: $(basename ${TARGET_BACKUP})"
            else
              TARGET_BACKUP="${BACKUP_DIR}/${BACKUP_ID}"
            fi

            if [ ! -d "${TARGET_BACKUP}" ]; then
              echo "‚ùå Error: Backup directory not found: ${TARGET_BACKUP}"
              exit 1
            fi

            echo "üîÑ Restoring from: ${TARGET_BACKUP}"

            # ÌòÑÏû¨ ÏÉÅÌÉú Î∞±ÏóÖ (Safety Backup)
            # Î°§Î∞± ÏãúÎèÑ Ï†Ñ, ÌòÑÏû¨ ÏÉÅÌÉúÎ•º ÏûÑÏãúÎ°ú Ï†ÄÏû•Ìï¥ÎëêÎäî Í≤ÉÏù¥ ÏïàÏ†ÑÌï®
            SAFETY_BACKUP="${BACKUP_DIR}/safety_before_rollback_$(date +%Y%m%d%H%M%S)"
            if [ -d "${FE_DIR}/.next" ]; then
               mkdir -p "${SAFETY_BACKUP}"
               cp -r "${FE_DIR}/.next" "${SAFETY_BACKUP}/"
               [ -f "${FE_DIR}/package.json" ] && cp "${FE_DIR}/package.json" "${SAFETY_BACKUP}/"
               echo "‚ÑπÔ∏è Safety backup created: ${SAFETY_BACKUP}"
            fi

            # ÌååÏùº Î≥µÍµ¨
            echo "Restore files..."
            rm -rf "${FE_DIR}/.next"
            cp -r "${TARGET_BACKUP}/.next" "${FE_DIR}/.next"

            # package.json Î≥µÍµ¨ (ÏùòÏ°¥ÏÑ± Î≥ÄÍ≤Ω Í∞ÄÎä•ÏÑ±)
            if [ -f "${TARGET_BACKUP}/package.json" ]; then
               cp "${TARGET_BACKUP}/package.json" "${FE_DIR}/package.json"
               echo "‚úÖ package.json restored"
            fi
            if [ -f "${TARGET_BACKUP}/pnpm-lock.yaml" ]; then
               cp "${TARGET_BACKUP}/pnpm-lock.yaml" "${FE_DIR}/pnpm-lock.yaml"
               echo "‚úÖ pnpm-lock.yaml restored"
            fi
            if [ -f "${TARGET_BACKUP}/next.config.ts" ]; then
               cp "${TARGET_BACKUP}/next.config.ts" "${FE_DIR}/next.config.ts"
               echo "‚úÖ next.config.ts restored"
            fi

            # public Ìè¥Îçî Î≥µÍµ¨
            if [ -d "${TARGET_BACKUP}/public" ]; then
               rm -rf "${FE_DIR}/public"
               cp -r "${TARGET_BACKUP}/public" "${FE_DIR}/public"
               echo "‚úÖ public folder restored"
            fi

            # Í∂åÌïú Î≥µÍµ¨
            sudo chown -R ubuntu:ubuntu "${FE_DIR}"

            # ÏùòÏ°¥ÏÑ± Ïû¨ÏÑ§Ïπò Î∞è Ïû¨ÏãúÏûë
            echo "Reinstalling dependencies and reloading PM2..."
            cd "${FE_DIR}"
            sudo -u ubuntu pnpm install --prod --frozen-lockfile --ignore-scripts

            sudo -u ubuntu pm2 reload ${APP_NAME} --update-env
            sleep 3

            # PM2 ÏÉÅÌÉú ÌôïÏù∏
            sudo -u ubuntu pm2 describe ${APP_NAME} > /dev/null || {
              echo "‚ùå PM2 process not running after reload"
              exit 1
            }

            # Caddy Î¶¨Î°úÎìú
            systemctl is-active --quiet caddy && sudo systemctl reload caddy 2>/dev/null || true
            sleep 10

            # Ìó¨Ïä§Ï≤¥ÌÅ¨ (ÏµúÎåÄ 5Ìöå Ïû¨ÏãúÎèÑ)
            echo "Running health check..."
            for i in {1..5}; do
              HTTP_STATUS=$(timeout 5 curl -s -o /dev/null -w "%{http_code}" "${HEALTH_CHECK_URL}" 2>/dev/null || echo "000")
              if [ "${HTTP_STATUS}" = "200" ]; then
                echo "‚úÖ Rollback successful! Service is healthy (HTTP ${HTTP_STATUS})"
                sudo -u ubuntu pm2 save 2>/dev/null || true
                sudo -u ubuntu pm2 status ${APP_NAME}
                exit 0
              fi
              echo "‚ö†Ô∏è  Attempt $i/5: HTTP ${HTTP_STATUS}"
              [ $i -lt 5 ] && sleep 3
            done

            echo "‚ùå Health check failed after rollback"
            sudo -u ubuntu pm2 logs ${APP_NAME} --lines 20 --nostream || true
            exit 1
          fi
          SCRIPT_END
          )
          
          # SSM Î™ÖÎ†π Ïã§Ìñâ
          SCRIPT_ENCODED=$(echo "$SCRIPT" | base64 -w 0)
          SSM_COMMAND="bash -c \"echo '$SCRIPT_ENCODED' | base64 -d | bash -s -- '$BASE_PATH' '$FE_DIR' '$BACKUP_DIR' '$MODE' '$BACKUP_ID' '$HEALTH_CHECK_URL'\""
          
          PARAMETERS_JSON=$(jq -n --arg cmd "$SSM_COMMAND" '{commands: [$cmd]}')
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$EC2_INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "$PARAMETERS_JSON" \
            --timeout-seconds 600 \
            --region ap-northeast-2 \
            --query 'Command.CommandId' \
            --output text)
            
          [ -n "$COMMAND_ID" ] || exit 1
          
          # Ïã§Ìñâ ÏÉÅÌÉú ÌôïÏù∏
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$EC2_INSTANCE_ID" \
              --region ap-northeast-2 \
              --query 'Status' \
              --output text 2>/dev/null || echo "InProgress")
            
            if [ "$STATUS" = "Success" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardOutputContent' \
                --output text
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$EC2_INSTANCE_ID" \
                --region ap-northeast-2 \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi
            sleep 3
          done
          exit 1

      - name: Notify Discord on Result
        if: always() && inputs.mode == 'restore'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
          BACKUP_ID: ${{ inputs.backup_id }}
          RUN_ID: ${{ github.run_id }}
        run: |
          # ÏÉÅÌÉúÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î∞è Ïù¥Î™®ÏßÄ ÏÑ§Ï†ï
          if [ "$STATUS" = "success" ]; then
            COLOR=3066993
            EMOJI="üîÑ"
            TITLE="Rollback Successful"
          else
            COLOR=15158332
            EMOJI="‚ö†Ô∏è"
            TITLE="Rollback Failed"
          fi

          # Backup ID ÌëúÏãú
          BACKUP_TEXT="${BACKUP_ID:-ÏµúÏã† Î∞±ÏóÖ}"

          # JSON ÌéòÏù¥Î°úÎìú ÏÉùÏÑ±
          payload=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI FE Î°§Î∞± Í≤∞Í≥º: $TITLE",
              "color": $COLOR,
              "fields": [
                {"name": "ÏÑúÎπÑÏä§", "value": "Re-Fit Frontend", "inline": true},
                {"name": "ÏÉÅÌÉú", "value": "\`$STATUS\`", "inline": true},
                {"name": "Î°§Î∞± ÎåÄÏÉÅ", "value": "\`$BACKUP_TEXT\`", "inline": false},
                {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[ÏÉÅÏÑ∏ Î≥¥Í∏∞](https://github.com/${{ github.repository }}/actions/runs/$RUN_ID)", "inline": false}
              ],
              "footer": { "text": "Re-Fit Rollback System" },
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )

          # Ï†ÑÏÜ°
          curl -H "Content-Type: application/json" -X POST -d "$payload" "$DISCORD_WEBHOOK"
